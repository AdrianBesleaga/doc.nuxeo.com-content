---
title: JSON Marshalling
labels:
    - marshalling
    - json
    - link-update
    - rest-api-component
toc: true
confluence:
    ajs-parent-page-id: '13664833'
    ajs-parent-page-title: REST API
    ajs-space-key: NXDOC
    ajs-space-name: Nuxeo Platform Developer Documentation
    canonical: JSON+Marshalling
    canonical_source: 'https://doc.nuxeo.com/display/NXDOC/JSON+Marshalling'
    page_id: '23367748'
    shortlink: RJBkAQ
    shortlink_source: 'https://doc.nuxeo.com/x/RJBkAQ'
    source_link: /display/NXDOC/JSON+Marshalling
history:
    - 
        author: Guillaume Renard
        date: '2016-06-01 12:38'
        message: ''
        version: '76'
    - 
        author: Manon Lumeau
        date: '2016-04-04 15:35'
        message: ''
        version: '75'
    - 
        author: Thomas Roger
        date: '2015-11-04 13:33'
        message: ''
        version: '74'
    - 
        author: Solen Guitter
        date: '2015-10-15 09:31'
        message: Add anchor
        version: '73'
    - 
        author: Solen Guitter
        date: '2015-10-15 09:29'
        message: ''
        version: '72'
    - 
        author: Solen Guitter
        date: '2015-09-15 16:05'
        message: >-
            Split table in section JSON Marshallers Provided by the Nuxeo
            Platform
        version: '71'
    - 
        author: Solen Guitter
        date: '2015-09-15 15:19'
        message: ''
        version: '70'
    - 
        author: Solen Guitter
        date: '2015-09-15 14:46'
        message: 'Fix format page '
        version: '69'
    - 
        author: Manon Lumeau
        date: '2015-09-15 14:31'
        message: ''
        version: '68'
    - 
        author: Solen Guitter
        date: '2015-04-20 11:56'
        message: Add links
        version: '67'
    - 
        author: Solen Guitter
        date: '2015-04-20 09:43'
        message: fix typo
        version: '66'
    - 
        author: Solen Guitter
        date: '2015-04-16 15:13'
        message: >-
            Add links to javadoc in table JSON Marshallers Provided by the Nuxeo
            Platform
        version: '65'
    - 
        author: Solen Guitter
        date: '2015-04-16 11:59'
        message: split table in section RenderingContext API
        version: '64'
    - 
        author: Solen Guitter
        date: '2015-04-16 11:47'
        message: fix typo
        version: '63'
    - 
        author: Solen Guitter
        date: '2015-04-16 10:07'
        message: ''
        version: '62'
    - 
        author: Solen Guitter
        date: '2015-04-16 09:55'
        message: Add link to marshalling service on explorer
        version: '61'
    - 
        author: Solen Guitter
        date: '2015-04-15 15:17'
        message: Fix typos and add links
        version: '60'
    - 
        author: Solen Guitter
        date: '2015-04-07 14:38'
        message: cleanup formatting
        version: '59'
    - 
        author: Manon Lumeau
        date: '2015-03-26 14:34'
        message: ''
        version: '58'
    - 
        author: Manon Lumeau
        date: '2015-03-26 14:33'
        message: ''
        version: '57'
    - 
        author: Manon Lumeau
        date: '2015-03-26 14:07'
        message: ''
        version: '56'
    - 
        author: Manon Lumeau
        date: '2015-03-26 13:54'
        message: ''
        version: '55'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-25 14:33'
        message: ''
        version: '54'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-25 07:52'
        message: ''
        version: '53'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-25 07:46'
        message: ''
        version: '52'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 16:46'
        message: ''
        version: '51'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 16:43'
        message: ''
        version: '50'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 16:36'
        message: ''
        version: '49'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 16:35'
        message: ''
        version: '48'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 16:32'
        message: ''
        version: '47'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 16:04'
        message: ''
        version: '46'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 16:02'
        message: ''
        version: '45'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 16:00'
        message: ''
        version: '44'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 15:58'
        message: ''
        version: '43'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 15:20'
        message: ''
        version: '42'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 15:17'
        message: ''
        version: '41'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 14:47'
        message: ''
        version: '40'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 14:45'
        message: ''
        version: '39'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 14:40'
        message: ''
        version: '38'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 14:24'
        message: ''
        version: '37'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 14:20'
        message: ''
        version: '36'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 14:05'
        message: ''
        version: '35'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 13:21'
        message: ''
        version: '34'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 12:46'
        message: ''
        version: '33'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 12:42'
        message: ''
        version: '32'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 12:37'
        message: ''
        version: '31'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 12:32'
        message: ''
        version: '30'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 12:26'
        message: ''
        version: '29'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 11:28'
        message: ''
        version: '28'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 11:13'
        message: ''
        version: '27'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 10:57'
        message: ''
        version: '26'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 10:28'
        message: ''
        version: '25'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 09:59'
        message: ''
        version: '24'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 09:58'
        message: ''
        version: '23'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 09:56'
        message: ''
        version: '22'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-24 09:45'
        message: ''
        version: '21'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 16:19'
        message: ''
        version: '20'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 16:17'
        message: ''
        version: '19'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 16:09'
        message: ''
        version: '18'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 15:25'
        message: ''
        version: '17'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 15:24'
        message: ''
        version: '16'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 15:16'
        message: ''
        version: '15'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 15:13'
        message: ''
        version: '14'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 15:09'
        message: ''
        version: '13'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 15:08'
        message: ''
        version: '12'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 14:39'
        message: ''
        version: '11'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 14:24'
        message: ''
        version: '10'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 12:36'
        message: ''
        version: '9'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 12:13'
        message: ''
        version: '8'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 12:10'
        message: ''
        version: '7'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 12:05'
        message: ''
        version: '6'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 11:57'
        message: ''
        version: '5'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 11:30'
        message: ''
        version: '4'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 11:29'
        message: ''
        version: '3'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 11:29'
        message: ''
        version: '2'
    - 
        author: Nicolas Chapurlat
        date: '2015-03-23 09:51'
        message: ''
        version: '1'

---
The Nuxeo Platform provides an&nbsp;extensible and&nbsp;customizable marshalling service:&nbsp;[MarshallerRegistry](http://explorer.nuxeo.com/nuxeo/site/distribution/latest/viewService/org.nuxeo.ecm.core.io.registry.MarshallerRegistry). This service allows you to use built-ins but also to register your own marshallers. The marshalling service&nbsp;facilitates the configuration of the rendered JSON, the aggregation of a marshaller from another and the possibility to extend or override existing marshallers.

The marshalling service is set up for the REST API v1 and the Automation server. Therefore, it is possible to operate all rendering parameters for the corresponding provided services.

The JSON generation and parsing is based on [Jackson](https://github.com/FasterXML/jackson).

## Creating Your Own Marshaller

The marshalling service allows you to create JSON-to-Java and Java-to-JSON marshallers.&nbsp;To create a marshaller, you have to write a Java class that manages the marshalling and registers it using a contribution.

Let's suppose we'd like to create marshallers for the following Java object:

```
 public class Product {

    private String reference;
    public int getReference() { return reference; }
    public void setReference(int reference) { this.reference = reference; }

    private String description;
    public String getDescription() { return description; }
    public void setDescription(String description) { this.description = description; }

} 
```

### Creating a Java-to-JSON Marshaller

A Java-to-JSON marshaller must implement the&nbsp;`org.nuxeo.ecm.core.io.registry.Writer<EntityType>` class. It must have a&nbsp;`@Setup` annotation to register it as a marshaller and a `@Supports` annotation to specify the supported mimetype (JSON in our example).&nbsp;The `Product` class is a POJO, we can either use Jackson POJO marshalling capabilities or create a custom JSON marshalling.

```
 @Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class ProductJsonWriter extends AbstractJsonWriter {
    public void write(Product product, JsonGenerator jg) throws IOException {
        jg.writeObject(product);
    }
}
```

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class ProductJsonWriter extends AbstractJsonWriter {
    public void write(Product product, JsonGenerator jg) throws IOException {
        jg.writeStartObject();
        jg.writeNumberField("ref", product.getReference());
        jg.writeStringField("desc", product.getDescription());
        jg.writeEndObject();
    }
}
```

*   The `@Setup` annotation is here to define our object as a marshaller.
*   The `mode = Instanciations.SINGLETON`&nbsp;parameter defines that the marshaller must be instanciated once.
*   The `priority = Priorities.REFERENCE`&nbsp;parameter defines it as the default one for the Product class.
*   The&nbsp;`AbstractJsonWriter` super-class is the Java-to-JSON Marshaller's base class (it has the `@Supports("application/json")` annotation).&nbsp;It helps to write the marshaller and to reuse the existing JSON marshalling.

### Creating a JSON-to-Java Marshaller

A JSON-to-Java marshaller must implement the&nbsp;`org.nuxeo.ecm.core.io.registry.Reader<EntityType>` class. It must have a&nbsp;`@Setup` annotation to register it as a marshaller and a `@Supports` annotation to specify the supported mimetype (JSON in our example).&nbsp;The Product class is a POJO, we can either use Jackson POJO marshalling capabilities or create a custom JSON marshalling.

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class ProductJsonReader extends AbstractJsonReader {
    public Product read(JsonNode jn) throws IOException {
        return new ObjectMapper().readValue(jn, Product.class);
    }
}
```

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class ProductJsonReader extends AbstractJsonReader {
    public Product read(JsonNode jn) throws IOException {
        Product product = new Product();
        product.setReference(jn.get("reference").getIntValue());
        product.setDescription(jn.get("description").getTextValue());
        return product;
    }
}
```

&nbsp;

*   The `@Setup` annotation is here to define our object as a marshaller.
*   The `mode = Instanciations.SINGLETON` parameter defines that the marshaller must be instanciated once.
*   The `priority = Priorities.REFERENCE` parameter defines it as the default one for the `Product` class.
*   The `AbstractJsonReader` super-class is the JSON-to-Java Marshaller's base class (it has the `@Supports("application/json")` annotation). It helps to write the marshaller and to reuse the existing JSON marshalling.

Each marshaller supports injection of the `RenderingContext` or any Nuxeo service using the `@java.inject.Inject` annotation. The injected objects are inherited while extending an existing class. The `AbstractJsonWriter` and the `AbstractJsonReader` provide the RenderingContext ("ctx" attribute) and the `MarshallingRegistry` ("registry" attribute).

### Managing Lists

The Nuxeo Platform provides built-in abstract classes to manage lists.

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class ProductListJsonWriter extends DefaultListJsonWriter {
    public ProductListJsonWriter() {
        super("products", Product.class);
    }
}
```

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class ProductListJsonReader extends DefaultListJsonReader {
    public ProductListJsonReader() {
        super("products", Product.class);
    }
}
```

### Registering Your Marshallers

The marshalling service provides an extension point : [`org.nuxeo.ecm.core.io.MarshallerRegistry/marshallers`](http://explorer.nuxeo.com/nuxeo/site/distribution/latest/viewExtensionPoint/org.nuxeo.ecm.core.io.MarshallerRegistry--marshallers) . It allows to add new marshallers, override existing ones or unregister some.

### Using Your Marshallers

*   From a JAX-RS endpoint

    1.  Make sure your WebEngine application provides the nuxeo-core-io marshalling.

        If it extends automation server or REST API v1, it's ok.

        Otherwise, you have to register a single JAX-RS object in your application.

        ```
        public class ProductApplication extends WebEngineModule {
            public Set getSingletons() {
                return Sets.newHashSet(new JsonCoreIODelegate());
            }
        }
        ```

    2.  From your REST endpoints, just consume or return Product as usual.

        ```
        @GET
        @Produces(MediaType.APPLICATION_JSON)
        public Product doGet() {
            Product product;
            // get the product
            return product;
        }

        @POST
        @Consumes(MediaType.APPLICATION_JSON)
        public Response doPost(Product product) {
            // do something with the product
            return Response.ok().build();
        }
        ```

*   Outside JAX-RS

    You can use the Nuxeo Platform marshalling service outside the web context. The simplest way is to use `org.nuxeo.ecm.core.io.registry.MarshallerHelper`.

    ```
    Product product = ...;
    String json = MarshallingHelper.objectToJson(product, CtxBuilder.get());
    ```

    The `MarshallingHelper` class is a helper to use the `MarshallingRegistry` service. This service provides multiple ways to get marshallers depending on your needs.

    ```
    Product product = ...;
    OutputStream target = ...;

    MarshallerRegistry registry = Framework.getService(MarshallerRegistry.class);

    // get the most priorized JSON Writer for Product
    Writer writer = registry.getWriter(CtxBuilder.get(), Product.class, MediaType.APPLICATION_JSON_TYPE);
    writer.write(object, Product.class, Product.class, APPLICATION_JSON_TYPE, target);

    // get a specific JSON Writer instance
    ProductJsonWriter writer = registry.getInstance(CtxBuilder.get(), ProductJsonWriter.class);
    writer.write(object, Product.class, Product.class, APPLICATION_JSON_TYPE, target);

    // get the most priorized JSON Writer for Product
    // associated with the given context and available for use in multiple threads (usefull for use in listeners or schedulers)
    Writer writer = registry.getUniqueWriter(CtxBuilder.get(), Product.class, Product.class, MediaType.APPLICATION_JSON_TYPE);
    writer.write(object, Product.class, Product.class, APPLICATION_JSON_TYPE, target);

    // get a specific JSON Writer instance
    // associated with the given context and available for use in multiple threads (usefull for use in listeners or schedulers)
    ProductJsonWriter writer = registry.getUniqueInstance(CtxBuilder.get(), ProductJsonWriter.class);
    writer.write(object, Product.class, Product.class, APPLICATION_JSON_TYPE, target);

    // advanced use for Java class based on generic type
    List products = ...;
    // use TypeUtils from commons-lang3 to get the generic type
    Type productListType = TypeUtils.parametrize(List.class, Product.class)
    Writer> writer = registry.getWriter(CtxBuilder.get(), List.class, productListType, MediaType.APPLICATION_JSON_TYPE);
    writer.write(object, List.class, productListType, APPLICATION_JSON_TYPE, target);
    ```

*   From another marshaller: The easiest way to do that is to extends `AbstractJsonWriter` or `AbstractJsonReader`.

    ```
    @Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
    public class AnObjectJsonWriter extends AbstractJsonWriter {
        public void write(AnObject anObject, JsonGenerator jg) throws IOException {
            jg.writeStartObject();
            jg.writeStringField("someField", anObject.getSomeField());

            Product product = anObject.getProduct();

            // this will generates the product json using the provided Java-to-JSON marshaller
            writeEntityField("product", product, jg);
            // same things with 2 calls
            jg.writeFieldName("product");
            writeEntity(product, jg);

            // or even, use the inherited "registry" attribute to get your marshaller and do what you want

            jg.writeEndObject();
        }
    }
    ```

## Parameterizing and Reusing Marshallers

The Nuxeo Platform marshalling service provides a rendering context. This context allows you to parametrize your JSON marshallers. For example you can decide to add a parameter which tells your marshaller to fetch or not some parts of the rendered object.

### Usages

This context is managed by the class `org.nuxeo.ecm.core.io.registry.context.RenderingContext`. A helper is provided to easily create a context: `org.nuxeo.ecm.core.io.registry.context.RenderingContext.CtxBuilder`.

When the marshalling service is used from JAX-RS, the context is filled with:

*   The Nuxeo URL
*   The client locale
*   The given [HTTP headers]({{page page='special-http-headers'}})
*   The GET parameters
*   The Java Request attributes

If you add parametrized behaviors to your marshaller, it is then customizable by the end-user application using the corresponding parameter in headers or in GET parameters.

```
@Setup(mode = SINGLETON, priority = Priorities.REFERENCE)
public class ProductJsonWriter extends AbstractJsonWriter {
    public void write(Product product, JsonGenerator jg) throws IOException {
        jg.writeStartObject();
        jg.writeNumberField("ref", product.getReference());
        if (ctx.getBooleanParameter("loadProductDescription")) {
            jg.writeStringField("desc", product.getDescription());
        }
        String url = ctx.getBaseUrl() + "/productApp/product/ref/" + product.getReference();
        jg.writeStringField("url", url);
        jg.writeEndObject();
    }
}
```

You can send the parameters using HTTP GET parameter or HTTP header (useful for POST/PUT/DELETE results).

```
$ curl -X GET 'http://localhost:8080/nuxeo/site/productApp/product/ref/10001?loadProductDescription=true'
$ curl -X GET -H 'loadProductDescription:true' 'http://localhost:8080/nuxeo/site/productApp/product/ref/10001' 
```

You can also use the rendering context from the server side using the `CtxBuilder`.

```
Product product = ...;
RenderindContext ctx = CtxBuilder.param("loadProductDescription", Boolean.TRUE).get();
String json = MarshallingHelper.objectToJson(product, ctx);
```

Finally, you can force the value of a parameter on the server side by overriding the rendering context used to produce the response.

```
@GET
@Produces(MediaType.APPLICATION_JSON)
public Product doGet(@Context HttpServletRequest request) {
    Product product;
    // get the product ... and configure output
    RenderindContext ctx = CtxBuilder.param("loadProductDescription", Boolean.TRUE).get();
    request.setAttribute(CTX_KEY, ctx);
    return product;
}
private static final String CTX_KEY = "_STORED_GENERATED_RENDERING_CONTEXT";
```

### RenderingContext API

#### Setting/Getting the Nuxeo Base URL

<table><tbody><tr><th colspan="1">Web context usage</th><td colspan="1">Retrieved from the HTTP call</td></tr><tr><th colspan="1">Server side usage</th><td colspan="1">

```
ctx = CtxBuilder.base("http://server/nuxeo").get();
```

</td></tr><tr><th colspan="1">Use from marshallers</th><td colspan="1">

```
String url = ctx.getBaseUrl();
```

</td></tr></tbody></table>

#### Setting/Getting the Current Locale

<table><tbody><tr><th colspan="1">Web context usage</th><td colspan="1">Retrieved from the end-user's browser</td></tr><tr><th colspan="1">Server side usage</th><td colspan="1">

```
ctx = CtxBuilder.locale(Locale.FRENCH).get();
```

</td></tr><tr><th colspan="1">Use from marshallers</th><td colspan="1">

```
Locale locale = ctx.getLocale();
```

</td></tr></tbody></table>

#### Delivering/Using a CoreSession to/in Marshallers

<table><tbody><tr><th colspan="1">Web context usage</th><td colspan="1">Retrieved from the WebContext, or from a document or created from a `nxrepository` parameter or created from a X-NXrepository header.</td></tr><tr><th colspan="1">Server side usage</th><td colspan="1">

```
CoreSession session = ...;
ctx = CtxBuilder.session(session).get();
```

</td></tr><tr><th colspan="1">Use from marshallers</th><td colspan="1">

The try-resource statement ensure the session would be closed if it's necessary

```
try (SessionWrapper wrapper = ctx.getSession(document)) {CoreSession session = wrapper.getSession();
    }
```

```
try (SessionWrapper wrapper = ctx.getSession(null)) {CoreSession session = wrapper.getSession();
    }
```

</td></tr></tbody></table>

#### Setting/Getting Any Parameter

<table><tbody><tr><th colspan="1">Web context usage</th><td colspan="1">

URL:

*   `.../some-url?paramName=paramValue`

HTTP Header:

*   `paramName:paramValue`

</td></tr><tr><th colspan="1">Server side usage</th><td colspan="1">

```
ctx = CtxBuilder.param("paramName", "paramValue").get();
```

```
ctx.setParameterValues("paramName", "paramValue");
```

</td></tr><tr><th colspan="1">Use from marshallers</th><td colspan="1">

```
Object o = ctx.getParameter("paramName");
```

```
List list = ctx.getParameters("paramName");
```

```
boolean b = ctx.getBooleanParameter("paramName");
```

</td></tr></tbody></table>

#### Loading Some Document Properties

<table><tbody><tr><th colspan="1">Web context usage</th><td colspan="1">

URL:

*   `.../some-url?properties=*`
*   `.../some-url?properties=dublincore,file`
*   `.../some-url?properties=dublincore&properties=file`

HTTP Header:

*   `X-NXproperties:*`
*   `X-NXproperties:dublincore,file`

</td></tr><tr><th colspan="1">Server side usage</th><td colspan="1">

```
ctx = CtxBuilder.properties("*").get();
```

```
ctx = CtxBuilder.properties("dublincore", "file").get();
```

```
ctx.setParameterValues("properties", "dublincore", "file");
```

</td></tr><tr><th colspan="1">Use from marshallers</th><td colspan="1">

```
Set properties = ctx.getProperties();
```

</td></tr></tbody></table>

#### Loading Additional Parts of an Object Whose entity-type Is 'objectType'

The corresponding behavior depends on the marshaller.

<table><tbody><tr><th colspan="1">Web context usage</th><td colspan="1">

URL:

*   `.../some-url?fetch.objectType=part1,part2`
*   `.../some-url?fetch.objectType=part1&fetch.objectType=part2`

HTTP Header:

*   `X-NXfetch.objectType:part1,part2`

</td></tr><tr><th colspan="1">Server side usage</th><td colspan="1">

```
ctx = CtxBuilder.fetchInDoc("part1", "part2").get();
```

```
ctx = CtxBuilder.fetch("objectType", "part1", "part2").get();
```

```
ctx.setParameterValues("fetch.objectType", "part1", "part2");
```

</td></tr><tr><th colspan="1">Use from marshallers</th><td colspan="1">

```
Set toLoad = ctx.getFetched("objectType");
```

</td></tr></tbody></table>

#### Enabling Enricher for an objectType

The enricher will contribute to the object marshalling. The object marshaller must extend `ExtensibleEntityJsonWriter`. The given enricher name must match an existing enricher for this object type.

<table><tbody><tr><th colspan="1">Web context usage</th><td colspan="1">

URL:

*   `.../some-url?enrichers.objectType=children,acl`
*   `.../some-url?enrichers.objectType=children&enrichers.objectType=acl`

HTTP Header:

*   `X-NXenrichers.objectType:children,acl`

</td></tr><tr><th colspan="1">Server side usage</th><td colspan="1">

```
ctx = CtxBuilder.enrichDoc("children", "acl").get(); 
```

```
ctx = CtxBuilder.enrich("objectType", "children", "acl").get();
```

```
ctx.setParameterValues("enrichers.objectType", "children", "acl");
```

</td></tr><tr><th colspan="1">Use from marshallers</th><td colspan="1">

```
Set enricherToActivate = ctx.getEnrichers("objectType");
```

</td></tr></tbody></table>

#### Translating Some Part of an Object Which May Contains Some l10n Key

<table><tbody><tr><th colspan="1">Web context usage</th><td colspan="1">

URL:

*   `.../some-url?translate.objectType=elementToTranslate`

HTTP Header:

*   `X-NXtranslate.objectType:elementToTranslate`

</td></tr><tr><th colspan="1">Server side usage</th><td colspan="1">

```
ctx = CtxBuilder.translate("objectType", "elementToTranslate").get();
```

```
ctx.setParameterValues("translate.objectType", "elementToTranslate");
```

</td></tr><tr><th colspan="1">Use from marshallers</th><td colspan="1">

```
Set toTranslate = ctx.getTranslated("objectType");
```

</td></tr></tbody></table>

#### Controlling the Aggregation Depth

Available values are: root for no aggregation, children for 1 level, max for 2 levels. Default value is 'children'. See next chapter for more details

<table><tbody><tr><th colspan="1">Web context usage</th><td colspan="1">

URL:

*   `.../some-url?depth=children`

HTTP Header:

*   `depth:children`

</td></tr><tr><th colspan="1">Server side usage</th><td colspan="1">

```
ctx = CtxBuilder.depth(DepthValues.children).get();
```

```
ctx.setParameterValues("depth", "children");
```

</td></tr><tr><th colspan="1">Use from marshallers</th><td colspan="1">

```
try (Closeable resource = ctx.wrap().controlDepth().open()) {
 // call another marshaller
} catch (MaxDepthReachedException e) {
 // do not load properties
}
```

</td></tr></tbody></table>

### Aggregating Marshallers and Avoiding Infinite Loops

Let's take an example. We created two classes, `Product` and `Category`. And we'd like to marshall them as JSON.

![]({{file name='Marshalling example UML - New Page.png'}} ?w=500,h=122,border=true)

When loading a category, we'd like to be able to get the corresponding products.

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class CategoryJsonWriter extends AbstractJsonWriter {
    public void write(Category category, JsonGenerator jg) throws IOException {
        jg.writeStartObject();
        jg.writeNumberField("ref", category.getReference());
        jg.writeStringField("desc", category.getDescription());
        if (ctx.getFetched("category").contains("products")) {
            jg.writeArrayFieldStart("products");
            for (Product product: product.getProducts()) {
                // delegates the marshalling to Nuxeo
                writeEntity(product);
            }
            jg.writeEndArray();
        }
        jg.writeEndObject();
    }
}
```

```
$ curl -X GET 'http://localhost:8080/nuxeo/site/productApp/category/ref/12?fetch.category=products'
```

When loading a product, we'd like to be able to get the corresponding categories.

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class ProductJsonWriter extends AbstractJsonWriter {
    public void write(Product product, JsonGenerator jg) throws IOException {
        jg.writeStartObject();
        jg.writeNumberField("ref", product.getReference());
        jg.writeStringField("desc", product.getDescription());
        if (ctx.getFetched("product").contains("categories")) {
            jg.writeArrayFieldStart("categories");
            for (Category category: product.getCategories()) {
                // delegates the marshalling to Nuxeo
                writeEntity(category);
            }
            jg.writeEndArray();
        }
        jg.writeEndObject();
    }
}
```

```
$ curl -X GET 'http://localhost:8080/nuxeo/site/productApp/category/ref/12?fetch.product=categories'
```

This works fine. But if we want to get both product's categories and category's products, there's a real risk to get an infinite loop. Or at least to get a very huge amount of JSON (if the category-product graph has no cycle).

```
$ curl -X GET 'http://localhost:8080/nuxeo/site/productApp/category/ref/12?fetch.product=categories&fetch.category=products'
```

![]({{file name='Marshalling example loops - New Page (1).png'}} ?w=500,h=412,border=true)

&nbsp;

To manage this case, we could use a counter put in the context but this will not work in most case because the counter will manage the first "line" of marshaller and disable the others: that's due to the processing which follows a "Depth First Search".

![]({{file name='Marshalling example loops - New Page (2).png'}} ?w=500,h=413,border=true)

The Nuxeo Platform provides a specific object to wrap the depth control in each "crossing line". Each time you call another marshaller, you should use it.

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class CategoryJsonWriter extends AbstractJsonWriter {
    public void write(Category category, JsonGenerator jg) throws IOException {
        jg.writeStartObject();
        jg.writeNumberField("ref", category.getReference());
        jg.writeStringField("desc", category.getDescription());
        // control the graph depth
        try (Closeable resource = ctx.wrap().controlDepth().open()) {
            if (ctx.getFetched("category").contains("products")) {
                jg.writeArrayFieldStart("products");
                for (Product product: product.getProducts()) {
                    // delegates the marshalling to Nuxeo
                    writeEntity(product);
                }
                jg.writeEndArray();
            }
        } catch (MaxDepthReachedException e) {
            // do not load products
        }
        jg.writeEndObject();
    }
}
```

The max depth is controlled by the `depth` parameter in the rendering context. The default value for depth is `children`.

Depth values: If we get a product -> its categories -> their products ...

*   **root**: No category will be loaded, just the first product.
*   **children**: The product is loaded with its categories.
*   **max**: The product is loaded, its categories also, and their products.

The only way to load more data is to avoid the use of depth control (which is bad!).

{{#> callout type='note' }}

Each existing Nuxeo writer/enricher, which may use another marshaller, uses the depth's control.

{{/callout}}

## Enriching / Extending / Overriding the Existing Marshallers

The Nuxeo Platform provides a flexible JSON marshalling. But sometimes, you'd like to add information from your Information System to the existing JSON or even override it to match your end-user needs.

There may be different needs:

*   Add information related to the marshalled object: Try to use built-in parameters, or else create an enricher.

*   Add existing informations to the JSON: Try to use built-in parameters, or else extend the existing marshaller.
*   Change the existing JSON: Override the existing marshaller.

### Enriching an Existing Marshaller

The enrichment mechanism is only enabled for the existing marshallers which extend [`ExtensibleEntityJsonWriter`](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/class-use/ExtensibleEntityJsonWriter.html) . That means, almost all of them support enrichment.

An enrichable JSON object provides a `contextParameters` field which contains all contributions. An enricher is activated if its name is specified in the parameters (for example: `enrichers.document=breadcrumb,children`). The enricher must write 0, 1 or many key-value in the current JsonGenerator and must let the JsonGenerator in the same state it got it.

```
{
    ... // the existing generated object
    contextParameters: {  // only present if at least one enricher is activated
        "theFirstEnricherKey": "theFirstEnricherValue",
        "theSecondEnricherKey": { ... },
        "theThirdEnricherKey-Entry1": { ... },
        "theThirdEnricherKey-Entry2": { ... }
    }
} 
```

Let's take the `breadcrumb` enricher as an example. It contributes to the generated JSON for a document and adds all of the parent documents.

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class BreadcrumbJsonEnricher extends AbstractJsonEnricher { // <= enrich="" DocumentModel="" Java="" type="" public="" BreadcrumbJsonEnricher()="" {="" super("breadcrumb");="" <="is" activated="" if="" "children"="" is="" in="" "enrichers.document"="" parameter's="" values="" }="" void="" write(JsonGenerator="" jg,="" document)="" throws="" IOException="" List parentDocuments = null;
        try (SessionWrapper wrapper = ctx.getSession(document)) {
            parentDocuments = wrapper.getSession().getParentDocuments(document.getRef());
        }
        jg.writeFieldName("breadcrumb"); // <= write="" "breadcrumb"="" as="" key="" writeEntity(documentList,="" jg);="" delegates="" the="" parent="" documents="" marshalling="" to="" Nuxeo="" }="" }<="" code=""/>
```

Of course, like any JSON marshaller, you have to register it.

That's all, you can now use it!

```
$ curl -X GET 'http://localhost:8080/nuxeo/site/api/v1/path/to/my/document?enrichers.document=breadcrumb'
```

All existing endpoints which return a DocumentModel will handle the registered enricher.

### Extending an Existing JSON Marshaller

If you want to add information at the root level of the existing JSON (not in a `contextParameters` sub object), you can extend an existing marshaller.

The extending mechanism is only enabled for the existing marshallers which extend [`ExtensibleEntityJsonWriter`](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/class-use/ExtensibleEntityJsonWriter.html) . That means, almost all of them support it.

{{#> callout type='note' }}

That could be dangerous if you use some JSON attributes which name already exists is the inherited JSON. Double check it!

{{/callout}}

Let's take an example with the DocumentModel. The current marshaller class for DocumentModel is `DocumentModelJsonWriter`.

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.OVERRIDE_REFERENCE) // <= an="" higher="" priority="" is="" used="" public="" class="" MyCustomDocumentModelJsonWriter="" extends="" DocumentModelJsonWriter="" {="" <="override" the="" protected="" void="" extend(DocumentModel="" document,="" JsonGenerator="" jg)="" throws="" IOException="" implement="" inherited="" extend="" method="" super.extend(document,="" jg);="" optionnal="" jg.writeStringField("additional",="" "information");="" feel="" free="" to="" write="" anything="" }="" }<="" code=""/>
```

Don't forget to register the marshaller. The resulting object will contain the whole existing JSON with your additional data.

All existing endpoints which return a DocumentModel will return the extended JSON.

### Overriding an Existing JSON Marshaller

In this case, you want to completely rewrite an existing JSON.

{{#> callout type='note' }}

Be careful with this approach, the marshallers provided by Nuxeo are used in many provided tools and screens. If you change it, you may break some existing components.

{{/callout}}

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.OVERRIDE_REFERENCE) // <= an="" higher="" priority="" is="" used="" public="" class="" MyCustomDocumentModelJsonWriter="" extends="" AbstractJsonWriter {
    public void write(DocumentModel document, JsonGenerator jg) throws IOException {
        // generate what you want
    }
}
```

## JSON Marshallers Provided by the Nuxeo Platform

Each existing marshaller class provides a well documented Javadoc. Please, read the corresponding Javadoc to understand the generated JSON format and the available parameters.

#### **document**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentModel

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[DocumentModelJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/document/DocumentModelJsonWriter.html)

</td><td colspan="1">

Writes a document as JSON. It is enrichable and extendable.

*   `properties=*`
    Loads all document's properties
*   `properties=dublincore,file`
    Loads only `dublincore` and `file` schemas
*   `fetch.document=properties`
    Loads every properties associated with a resolver
*   `fetch.document=versionLabel`
    Loads the versioning information
*   `fetch.document=lock`
    Loads the lock owner and the lock date

</td></tr><tr><td colspan="1">

DocumentModel

</td><td colspan="1">

JSON-to-Java

</td><td colspan="1">

[DocumentModelJsonReader](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/document/DocumentModelJsonReader.html)

</td><td colspan="1">

Reads a document from JSON. Supports either reference or JSON object for extended fields value.

*   If an uid is specified, it will update the existing document with the given properties. The result is a DocumentModelImpl ready to save.
*   Otherwise, you have to specify the name and the type of the document.
*   The result is a SimpleDocumentModel.

</td></tr></tbody></table>

#### **document / acls**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentModel

</td><td colspan="1">

Java-to-JSON Enricher

</td><td colspan="1">

[ACLJsonEnricher](http://community.nuxeo.com/api/nuxeo/latest/javadoc/org/nuxeo/ecm/permissions/ACLJsonEnricher.html)

</td><td colspan="1">

Enriches a document. Adds document ACLs.

Activated with `enrichers.document=acls.`

</td></tr></tbody></table>

#### **document / permissions**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentModel

</td><td colspan="1">

Java-to-JSON Enricher

</td><td colspan="1">

[BasePermissionsJsonEnricher](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/enrichers/BasePermissionsJsonEnricher.html)

</td><td colspan="1">

Enriches a document. Adds user's permission on the document.

Activated with `enrichers.document=permissions`.

</td></tr></tbody></table>

#### **document / breadcrumb**

<table><tbody><tr><th colspan="1">Managed Java type</th><th colspan="1">Type</th><th colspan="1">Java class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentModel

</td><td colspan="1">

Java-to-JSON Enricher

</td><td colspan="1">

[BreadcrumbJsonEnricher](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/enrichers/BreadcrumbJsonEnricher.html)

</td><td colspan="1">

Enriches a document. Add the parent's documents.

Activated with `enrichers.document=breadcrumb`.

</td></tr></tbody></table>

#### **document / children**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentModel

</td><td colspan="1">

Java-to-JSON Enricher

</td><td colspan="1">

[ChildrenJsonEnricher](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/enrichers/ChildrenJsonEnricher.html)

</td><td colspan="1">

Enriches a document. Adds the children documents.

Activated with `enrichers.document=children`.

</td></tr></tbody></table>

#### **document / contextualParameters**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentModel

</td><td colspan="1">

Java-to-JSON Enricher

</td><td colspan="1">

[ContextualParametersJsonEnricher](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/enrichers/ContextualParametersJsonEnricher.html)

</td><td colspan="1">

Enriches a document with free key/value pair. Only from the server side.

```
String name = "contextualParameters"; 
Map keyValues = ...; 
ctx.enrich(name).param(name, keyValues).get();
```

</td></tr></tbody></table>

#### **document / preview**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentModel

</td><td colspan="1">

Java-to-JSON Enricher

</td><td colspan="1">

[PreviewJsonEnricher](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/preview/io/PreviewJsonEnricher.html)

</td><td colspan="1">

Enriches a document. Adds the URL of its preview.

Activated with `enrichers.document=preview`.

</td></tr></tbody></table>

#### **document / thumbnail**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentModel

</td><td colspan="1">

Java-to-JSON Enricher

</td><td colspan="1">

[ThumbnailJsonEnricher](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/ui/web/io/ThumbnailJsonEnricher.html)

</td><td colspan="1">

Enriches a document. Adds the URL of its thumbnail.

Activated with `enrichers.document=thumbnail`.

</td></tr></tbody></table>

#### **documents**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

List<DocumentModel>

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[DocumentModelListJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/document/DocumentModelListJsonWriter.html)

</td><td colspan="1">

Writes a list of document as JSON.

Supports paginated lists and provides pagination information.

Delegates the document's writing to the Nuxeo Platform.

</td></tr><tr><td colspan="1">

List<DocumentModel>

</td><td colspan="1">

JSON-to-Java

</td><td colspan="1">

[DocumentModelListJsonReader](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/document/DocumentModelListJsonReader.html)

</td><td colspan="1">

Reads a list of document from JSON.

Delegates the document's reading to the Nuxeo Platform.

</td></tr></tbody></table>

#### **acls**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

ACP

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[ACPJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/document/ACPJsonWriter.html)

</td><td colspan="1">

Writes a set of access right as JSON. It is enrichable and extendable

</td></tr></tbody></table>

#### **docType**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentType

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[DocumentTypeJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/types/DocumentTypeJsonWriter.html)

</td><td colspan="1">

Writes a document's type as JSON.

It is enrichable and extendable

Delegates the writing of the type's schemas to the Nuxeo Platform.

</td></tr></tbody></table>

#### **docTypes**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

List<DocumentType>

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[DocumentTypeListJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/types/DocumentTypeListJsonWriter.html)

</td><td colspan="1">

Writes a list of document's types as JSON.

Supports paginated lists and provides pagination information.

Delegates the type's writing to the Nuxeo Platform.

</td></tr></tbody></table>

#### **facet**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

CompositeType

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[FacetJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/types/FacetJsonWriter.html)

</td><td colspan="1">

Writes a document's facet as JSON.

It is enrichable and extendable.

Delegates the writing of the facet's schemas to the Nuxeo Platform.

</td></tr></tbody></table>

#### **facets**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

List<CompositeType>

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[FacetListJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/types/FacetListJsonWriter.html)

</td><td colspan="1">

Writes a list of facets as JSON.

Supports paginated lists and provides pagination information.

Delegates the facet's writing to the Nuxeo Platform.

</td></tr></tbody></table>

#### **schema**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

Schema

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[SchemaJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/types/SchemaJsonWriter.html)

</td><td colspan="1">

Writes a schema as JSON.

It is enrichable and extendable.

</td></tr></tbody></table>

#### **schemas**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

List<Schema>

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[SchemaListJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/types/SchemaListJsonWriter.html)

</td><td colspan="1">

Writes a list of schemas as JSON.

Supports paginated lists and provides pagination information.

Delegates the schema's writing to the Nuxeo Platform.

</td></tr></tbody></table>

#### **validation_constraint**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

Constraint

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[ConstraintJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/validation/ConstraintJsonWriter.html)

</td><td colspan="1">

Writes a validation constraint as JSON.

It is enrichable and extendable.

</td></tr></tbody></table>

#### **validation_constraints**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

List<Constraint>

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[ConstraintListJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/validation/ConstraintListJsonWriter.html)

</td><td colspan="1">

Writes a list of constraints as JSON.

Supports paginated lists and provides pagination information.

Delegates the constraint's writing to the Nuxeo Platform.

</td></tr></tbody></table>

#### **validation_report**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentValidationReport

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[DocumentValidationReportJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/core/io/marshallers/json/validation/DocumentValidationReportJsonWriter.html)

</td><td colspan="1">

Writes a validation report as JSON.

It is enrichable and extendable.

Delegates the constraint's writing to the Nuxeo Platform.

</td></tr></tbody></table>

#### **user**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

NuxeoPrincipal

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[NuxeoPrincipalJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.html)

</td><td colspan="1">

Writes a user as JSON.

It is enrichable and extendable.

</td></tr><tr><td colspan="1">

NuxeoPrincipal

</td><td colspan="1">

JSON-to-Java

</td><td colspan="1">

[NuxeoPrincipalJsonReader](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonReader.html)

</td><td colspan="1">

Reads a user from JSON

</td></tr></tbody></table>

#### **users**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

List<NuxeoPrincipal>

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[NuxeoPrincipalListJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalListJsonWriter.html)

</td><td colspan="1">

Writes a list of users as JSON.

Supports paginated lists and provides pagination information.

Delegates the user's writing to the Nuxeo Platform.

</td></tr><tr><td colspan="1">

List<NuxeoPrincipal>

</td><td colspan="1">

JSON-to-Java

</td><td colspan="1">

[NuxeoPrincipalListJsonReader](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalListJsonReader.html)

&nbsp;

</td><td colspan="1">

Reads a list of users from JSON.

Delegates the user's reading to the Nuxeo Platform

</td></tr></tbody></table>

#### **group**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

NuxeoGroup

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[NuxeoGroupJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/usermanager/io/NuxeoGroupJsonWriter.html)

</td><td colspan="1">

Writes a group as JSON.

It is enrichable and extendable.

</td></tr><tr><td colspan="1">

NuxeoGroup

</td><td colspan="1">

JSON-to-Java

</td><td colspan="1">

[NuxeoGroupJsonReader](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/usermanager/io/NuxeoGroupJsonReader.html)

</td><td colspan="1">

Reads a group from JSON

</td></tr></tbody></table>

#### **groups**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

List<NuxeoGroup>

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[NuxeoGroupListJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/usermanager/io/NuxeoGroupListJsonWriter.html)

</td><td colspan="1">

Writes a list of groups as JSON.

Supports paginated lists and provides pagination information.

Delegates the group's writing to the Nuxeo Platform

</td></tr><tr><td colspan="1">

List<NuxeoGroup>

</td><td colspan="1">

JSON-to-Java

</td><td colspan="1">

[NuxeoGroupListJsonReader](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/usermanager/io/NuxeoGroupListJsonReader.html)

</td><td colspan="1">

Reads a list of groups from JSON.

Delegates the group's reading to the Nuxeo Platform.

</td></tr></tbody></table>

#### directoryEntry

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DirectoryEntry

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[DirectoryEntryJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/directory/io/DirectoryEntryJsonWriter.html)

</td><td colspan="1">

Writes a directory entry as JSON. It is enrichable and extendable

*   `fetch.directoryEntry=parent`
    Loads the entry's `parent` field as the corresponding entry in the same directoryL
    Useful for `dc:subjects` or `dc:coverage` values.
*   `translate.directoryEntry=label`
    Translates the label if it matches an existing l10n key.
    Useful for `dc:nature` values.

</td></tr><tr><td colspan="1">

DirectoryEntry

</td><td colspan="1">

JSON-to-Java

</td><td colspan="1">

[DirectoryEntryJsonReader](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/directory/io/DirectoryEntryJsonReader.html)

</td><td colspan="1">

Reads a directory entry from JSON

</td></tr></tbody></table>

#### **directoryEntries**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

List<DirectoryEntry>

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[DirectoryEntryListJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/directory/io/DirectoryEntryListJsonWriter.html)

</td><td colspan="1">

Writes a list of directory entries as JSON.

Supports paginated lists and provides pagination information.

Delegates the directory entries writing to the Nuxeo Platform.

</td></tr><tr><td colspan="1">

List<DirectoryEntry>

</td><td colspan="1">

JSON-to-Java

</td><td colspan="1">

[DirectoryEntryListJsonReader](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/directory/io/DirectoryEntryListJsonReader.html)

</td><td colspan="1">

Reads a list of directory entries from JSON.

Delegates the directory entries reading to the Nuxeo Platform.

</td></tr></tbody></table>

#### **logEntry**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

LogEntry

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[LogEntryJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/audit/io/LogEntryJsonWriter.html)

</td><td colspan="1">

Writes an audit entry to JSON.

It is enrichable and extendable.

</td></tr><tr><td colspan="1">

List<LogEntry>

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[LogEntryListJsonWriter](http://community.nuxeo.com/api/nuxeo/7.2/javadoc/org/nuxeo/ecm/platform/audit/io/LogEntryListJsonWriter.html)

</td><td colspan="1">

Writes a list of audit entries to JSON

It is enrichable and extendable.

Delegates the entries writing to the Nuxeo Platform.

</td></tr></tbody></table>

#### **workflow**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

DocumentRoute

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[DocumentRouteWriter](http://community.nuxeo.com/api/nuxeo/8.3/javadoc/org/nuxeo/ecm/platform/routing/core/io/DocumentRouteWriter.html)

</td><td colspan="1">

Writes a workflow instance (DocumentRoute) as JSON. It is enrichable and extendable.

*   `fetch.workflow=initiator`
    Resolves the initiator.
*   `fetch.workflow=attachedDocumentIds`
    Resolves the attached document Ids

</td></tr></tbody></table>

#### **task**

<table><tbody><tr><th colspan="1">Managed Java Type</th><th colspan="1">Type</th><th colspan="1">Java Class</th><th colspan="1">Behavior</th></tr><tr><td colspan="1">

Task

</td><td colspan="1">

Java-to-JSON

</td><td colspan="1">

[TaskWriter](http://community.nuxeo.com/api/nuxeo/8.3/javadoc/org/nuxeo/ecm/platform/routing/core/io/TaskWriter.html)

</td><td colspan="1">

Writes a task as JSON. It is enrichable and extendable.

*   `fetch.task=actors`
    Resolves the actors.
*   `fetch.task=targetDocumentIds`
    Resolves the target document Ids

</td></tr></tbody></table>

## Document JSON and Extended Fields

Nuxeo Platform 7.2 introduces the concept of Extended fields. See [Field Constraints and Validation]({{page page='field-constraints-and-validation'}}) and [How to Customize Document Validation]({{page page='how-to-customize-document-validation'}}).

This kind of document field are defined as reference to external object. For example, in the Dublin Core schema:

*   `dc:creator` and `dc:lastContributors` are references to Nuxeo users
*   `dc:contributors` contains references to Nuxeo users
*   `dc:subjects` contains references to the "l10nsubjects" directory entries
*   `dc:coverage` is a reference to the "l10ncoverage" directory entry
*   `dc:nature` is a reference to the "nature" directory entry

### Usage

The document marshalling provides a nice way to get the data referenced by one of its fields in-place.

For example, a call to get the JSON of a document which creator is the user "johnd" will return:

```
$ curl -X GET 'http://localhost:8080/nuxeo/site/api/v1/path/to/my/document?properties=dublincore'
```

```
{  
  "entity-type":"document",
  "properties":{  
    "dc:creator": "johnd",
    ...
  },
  ...
}
```

If we tell the document marshaller to load the `dc:creator` referenced value, it will return the user's JSON in-place:

```
$ curl -X GET 'http://localhost:8080/nuxeo/site/api/v1/path/to/my/document?properties=dublincore&fetch.document=dc:creator'
```

```
{  
  "entity-type":"document",
  "properties":{  
    "dc:creator":{  
      "entity-type":"user",
      "id":"johndoe",
      "properties":{  
        "firstName":"John",
        "lastName":"Doe",
        "password":"",
        "groups":[  
          "members"
        ],
        "company":"Nuxeo",
        "email":"jown.doe@nuxeo.com",
        "username":"johnd"
      },
      "extendedGroups":[  
        {  
          "name":"members",
          "label":"Members group",
          "url":"group/members"
        }
      ],
      "isAdministrator":false,
      "isAnonymous":false
    },
    ...
  },
  ...
}
```

To load every extended fields of a document, use `fetch.document=properties`.

The Nuxeo Platform provides resolver for document, directory entry, user and group. It also provides Java-to-JSON marshaller for those objects. Therefore, you can fetch any property based on built-in resolvers.

### Updating Document Properties

If a field is defined as a reference and if you provide a JSON-to-Java marshaller for the referenced object, you can either update the document using the reference as usual or use the object's JSON to update the corresponding document property.

1.  The Nuxeo Platform uses the `ObjectResolver.getManagedClasses()` method to get the expected type.
2.  The Nuxeo Platform delegates the JSON-to-Java marshalling to the marshalling service.
3.  The marshalling service delegates the JSON parsing to the registered marshaller.
4.  The Nuxeo Platform uses the resolver to get the reference from the parsed object and update the property.

The platform also provides JSON-to-Java for document, directory entry, user and group. Therefore, you can update any field based on the corresponding resolvers using the referenced object JSON.

### Custom Resolver

When you create a custom resolver, if you want to be able to load the JSON of a referenced object, you have to register a Java-to-JSON marshaller.

If you want to be able to update a field using the JSON rather than the reference, you have to register a JSON-to-Java marshaller and be sure the `getManagedClasses()` method of your resolver returns the expected Java type.

## Testing JSON Data

The Nuxeo Platform offers a utility object to test JSON data: `org.nuxeo.ecm.core.io.marshallers.json.JsonAssert`. It is provided by nuxeo-core-io test-jar.

```

  org.nuxeo.ecm.core
  nuxeo-core-io
  test-jar
  test

```

### Testing a Simple Marshaller

Let's test the following marshaller:

```
@Setup(mode = Instantiations.SINGLETON, priority = Priorities.REFERENCE)
public class ProductJsonWriter extends AbstractJsonWriter {
    public void write(Product product, JsonGenerator jg) throws IOException {
        jg.writeStartObject();
        jg.writeNumberField("ref", product.getReference());
        jg.writeStringField("desc", product.getDescription());
        jg.writeEndObject();
    }
}
```

The test looks like:

```
public class ProductJsonWriterTest extends AbstractJsonWriterTest.Local {

    public ProductJsonWriterTest() {
        super(ProductJsonWriter.class, Product.class);
    }

    @Test
    public void test() throws Exception {
        Product product = new Product(123, "a description");
        JsonAssert json = jsonAssert(product);
        json.isObject().properties(2);
        json.has("ref").isEquals(product.getReference());
        json.has("desc").isEquals(product.getDescription());
    }

}
```

Each line makes an assertion on the provided JSON. Each assertion returns either the current JsonAssert (`json.isObject().properties(2)`) or a new JsonAssert based on the referenced data (`json.**has("reference")**.isEquals(product.getReference())`).

If your marshaller uses other marshallers, don't forget to load the corresponding contribution using `@Deploy` or `@LocalDeploy`.

### Testing an Enricher

If you wrote an enricher for DocumentModel, the tested object should be DocumentModel. In that case, don't forget to load the contribution which contains your enricher registering.

```
public class SomeEnricherTest extends AbstractJsonWriterTest.Local {

    public ProductJsonWriterTest() {
        super(DocumentModelJsonWriter.class, DocumentModel.class);
    }

    @Test
    public void test() throws Exception {
        DocumentModel doc = ...;
        RenderingContext ctx = CtxBuilder.enrichDoc("someEnricher").get();
        JsonAssert json = jsonAssert(doc, ctx);
        json = json.has("contextParameters.someEnricher");
        // make assertion on the enricher here
    }

}
```

### Testing Any JSON Data

You can also use `JsonAssert` to test the result of your services.

```
public class SomeJsonTest {

    @Test
    public void test() throws Exception {
        String jsonString = ...; // get JSON from somewhere
        JsonAssert json = JsonAssert.on(jsonString);
        // make assertion on the json here
    }

}
```

### Tips and Tricks

#### Getting the JSON

`JsonAssert` provides the ability to get the json at any level.

```
{
  "field1": { "field2": "hi!" },
  "field3": "hello"
}
```

```
JsonAssert json = ...;
System.out.println( json.toString() );
// will print the whole JSON
System.out.println( json.has("field1.field2").toString() );
// will print "hi!" - be careful, the quotes are keeped, that's the real JSON
```

#### Quickly Testing Deep Data

`JsonAssert` provides the ability to use JSON path.

```
{
  "field1": {
    "field2": [ {
        "field3": "myDataShouldBeHere"
    } ]
  }
} 
```

```
json.has("field1.field2[0].field3").isEquals("myDataShouldBeHere");
```

#### Quickly Testing Array Values

`JsonAssert` provides the ability to test array values.

```
{
  "field1": [ "A should be here", "B should be here", "C should be here twice", "C should be here twice" ]
}
```

```
json.has("field1").contains("A should be here", "B should be here", "C should be here twice", "C should be here twice");
```

#### Quickly Testing Complex Structure

`JsonAssert` provides the ability to test the value of a field for multiple object in an array.

```
{
  "field1": [
    { "field2": "A is here" },
    { "field2": "B is here twice" },
    { "field2": "B is here twice" }
  ]
}
```

```
json.childrenContains("field1.field2", "A is here", "B is here twice", "B is here twice");
```

`JsonAssert.childrenContains` can cross over multiple arrays and objects.

targetDocuments

&nbsp;

&nbsp;

&nbsp;